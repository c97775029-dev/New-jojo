<!DOCTYPE html>
<html>
<head>
    <title>Bizarre Legacy: Perfected V2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; touch-action: none; -webkit-user-select: none; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; color: #fff; display: none; pointer-events: none; z-index: 5; }
        .bar-bg { width: 140px; height: 15px; border: 2px solid #fff; background: #333; margin: 5px auto; border-radius: 5px; overflow: hidden; }
        #pBar, #eBar { width: 100%; height: 100%; transition: 0.1s; }
        #pBar { background: #0066ff; box-shadow: 0 0 10px #0066ff; } 
        #eBar { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        #msg { color: gold; font-size: 22px; text-shadow: 2px 2px #000; font-weight: bold; margin-top: 10px; }
        #ctrl { position: absolute; bottom: 40px; width: 100%; text-align: center; display: none; z-index: 10; }
        #qte { position: absolute; top: 50%; left: 50%; display: none; transform: translate(-50%, -50%); }
        #t-circ { width: 80px; height: 80px; border: 4px solid #fff; border-radius: 50%; position: absolute; transform: translate(-50%,-50%); }
        #r-circ { width: 200px; height: 200px; border: 4px solid gold; border-radius: 50%; position: absolute; transform: translate(-50%,-50%); }
        #oraBtn { padding: 25px 50px; font-size: 28px; font-weight: bold; border-radius: 15px; border: none; cursor: pointer; background: #f05; color: #fff; box-shadow: 0 6px #900; }
        #oraBtn:active { transform: translateY(4px); box-shadow: 0 2px #900; }
        #oraBtn:disabled { background: #444; box-shadow: 0 6px #222; opacity: 0.7; }
        #combo { position: absolute; left: 20px; top: 40%; color: gold; font-size: 45px; font-weight: 900; font-style: italic; display: none; text-shadow: 3px 3px #f00; pointer-events: none; }
        .ts-player { filter: hue-rotate(260deg) brightness(0.8) contrast(1.4); }
        .ts-dio { filter: invert(1) grayscale(1); }
    </style>
</head>
<body>
    <div id="ui">
        <div style="display:flex;justify-content:space-around">
            <div>JOTARO<div class="bar-bg"><div id="pBar"></div></div></div>
            <div>DIO<div class="bar-bg"><div id="eBar"></div></div></div>
        </div>
        <div id="msg">YARE YARE DAZE...</div>
    </div>
    <div id="combo">0 ORA!</div>
    <div id="qte"><div id="t-circ"></div><div id="r-circ"></div></div>
    <div id="ctrl"><button id="oraBtn">ORA!</button></div>
    
    <div id="menu" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#fff;background:rgba(0,0,0,0.9);padding:40px;border:4px solid gold; border-radius: 20px; z-index: 100;">
        <h1 style="color:gold; font-size: 40px;">BIZARRE LEGACY</h1>
        <p>JOTARO VS DIO</p>
        <button onclick="start()" style="background:gold; color:black; padding: 15px 30px; font-size: 20px; border-radius: 10px; cursor:pointer; font-weight:bold;">COMMENCE FIGHT</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const s = new THREE.Scene(), c = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), r = new THREE.WebGLRenderer({antialias:true});
        r.setSize(window.innerWidth, window.innerHeight); document.body.appendChild(r.domElement);
        s.add(new THREE.AmbientLight(0xffffff, 1)); c.position.z = 5;

        const p = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0x0066ff})); p.position.x = -2; s.add(p);
        const e = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 1.2), new THREE.MeshStandardMaterial({color: 0xff0000})); e.position.x = 2; s.add(e);
        const k = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.1, 0.1), new THREE.MeshStandardMaterial({color: 0xcccccc})); k.visible = false; s.add(k);
        
        let php=100, ehp=100, gOver=false, isTS=false, qteOn=false, rSize=200, qHits=0, isRetreating=false, knifeActive=false, knifeReturning=false;
        let parryAttempts = 0, lastTS = Date.now(), canAttack = true, shake = 0, combo = 0, comboTimer;

        const oraBtn = document.getElementById('oraBtn');
        // iPad fix
        oraBtn.addEventListener('touchstart', (ev) => { ev.preventDefault(); go(); });
        oraBtn.addEventListener('mousedown', (ev) => { if(!('ontouchstart' in window)) go(); });

        function start() {
            document.getElementById('menu').style.display='none';
            document.getElementById('ui').style.display=document.getElementById('ctrl').style.display='block';
            setInterval(eAtk, 3500); 
            setInterval(knifePhase, 9000);
            setInterval(() => { if(!gOver && !isTS && (Date.now() - lastTS > 12000)) qOn(); }, 4000);
        }

        function go() { 
            if(gOver) return;

            // 1. Knife Parry Logic (2 tries, Unlimited Click Spam speed)
            if(knifeActive && !knifeReturning) {
                parryAttempts++;
                if(parryAttempts <= 2 && k.position.x < -0.5 && k.position.x > -2.2) {
                    knifeReturning = true; k.material.color.set(0xffd700);
                    document.getElementById('msg').innerText = "PARRIED!!"; shake = 0.3; return;
                }
                if(parryAttempts > 2) return; 
            }

            // 2. Your Time Stop (Zero Cooldown, Spam enabled)
            if(isTS && document.body.classList.contains('ts-player')) {
                attackAction(1); // 1 damage per hit during TS
                return;
            }

            // 3. Normal Attack (0.5s Cooldown)
            if(!canAttack || isTS || isRetreating || qteOn) { 
                if(qteOn) qHit(); 
                return; 
            }

            attackAction(5); // 5 damage normal
            canAttack = false;
            oraBtn.disabled = true;
            setTimeout(() => { canAttack = true; oraBtn.disabled = false; }, 500); 
        }

        function attackAction(dmg) {
            ehp -= dmg; flash(e); shake = 0.12; addCombo(); upd();
            p.position.x = 0.5; setTimeout(()=>p.position.x=-2, 70);
        }

        function flash(obj) {
            const orig = obj.material.color.getHex();
            obj.material.color.set(0xffffff);
            setTimeout(() => obj.material.color.set(orig), 50);
        }

        function addCombo() {
            combo++;
            const cb = document.getElementById('combo');
            cb.innerText = combo + " ORA!"; cb.style.display = 'block';
            clearTimeout(comboTimer);
            comboTimer = setTimeout(() => { combo = 0; cb.style.display = 'none'; }, 1500);
        }
        
        function knifePhase() {
            if(gOver || isTS) return;
            isRetreating = true; knifeActive = true; knifeReturning = false; parryAttempts = 0;
            e.position.x = 5; document.getElementById('msg').innerText = "WATCH OUT!";
            setTimeout(() => {
                k.position.set(5, 0, 0); k.visible = true;
                const tLoop = setInterval(() => {
                    if(gOver || isTS) { clearInterval(tLoop); k.visible=false; return; }
                    if(!knifeReturning) {
                        k.position.x -= 0.32;
                        if(k.position.x <= -2.5) {
                            clearInterval(tLoop); k.visible = false; knifeActive = false;
                            php -= 20; shake = 0.5; upd(); e.position.x = 2; isRetreating = false;
                            document.getElementById('msg').innerText = "UGH!";
                        }
                    } else {
                        k.position.x += 0.75;
                        if(k.position.x >= 5) {
                            clearInterval(tLoop); k.visible = false; knifeActive = false;
                            ehp -= 30; flash(e); shake = 0.6; upd(); e.position.x = 2; isRetreating = false;
                        }
                    }
                }, 20);
            }, 600);
        }

        function eAtk() { 
            // DIO can't hit you if he's throwing knives or stopping time
            if(gOver || isTS || isRetreating || qteOn) return; 
            e.position.x = -1; php -= 10; shake = 0.35; flash(p); upd(); 
            setTimeout(()=>e.position.x=2, 100); 
        }

        function qOn() { qteOn=true; qHits=0; rSize=200; document.getElementById('qte').style.display='block'; document.getElementById('msg').innerText = "COUNTER!!"; }

        function qHit() { 
            if(rSize>70&&rSize<95){ 
                qHits++; rSize=200; 
                if(qHits>=3){ qteOn=false; document.getElementById('qte').style.display='none'; playerTS(); }
            } else { qteOn=false; document.getElementById('qte').style.display='none'; dioTS(); }
        }

        function playerTS() {
            isTS=true; lastTS = Date.now(); document.body.classList.add('ts-player');
            document.getElementById('msg').innerText = "STAR PLATINUM: THE WORLD!";
            setTimeout(() => { isTS = false; document.body.classList.remove('ts-player'); document.getElementById('msg').innerText = "TIME RESUMES"; }, 5000);
        }

        function dioTS() {
            isTS=true; lastTS = Date.now(); document.body.classList.add('ts-dio');
            document.getElementById('msg').innerText = "ZA WARUDO!!";
            let h=0; const l=setInterval(()=>{
                if(gOver){clearInterval(l);return;}
                e.position.x=-1; php-=5; flash(p); shake=0.25; upd();
                setTimeout(()=>e.position.x=2,120); h++;
                if(h>=8){clearInterval(l); isTS=false; document.body.classList.remove('ts-dio');}
            }, 750);
        }

        function upd() { 
            document.getElementById('pBar').style.width=Math.max(0,php)+'%'; 
            document.getElementById('eBar').style.width=Math.max(0,ehp)+'%'; 
            if(php<=0||ehp<=0) { 
                gOver=true; 
                document.getElementById('msg').innerText = php<=0 ? "YOU WERE RETIRED" : "DIO DEFEATED!";
                setTimeout(() => location.reload(), 3000);
            }
        }

        function animate() { 
            requestAnimationFrame(animate);
            if(shake > 0) {
                c.position.x = (Math.random()-0.5) * shake;
                c.position.y = (Math.random()-0.5) * shake;
                shake *= 0.85;
            } else { c.position.x = c.position.y = 0; }
            if(!isRetreating && !isTS) e.position.y = Math.sin(Date.now()*0.003)*0.25;
            if(qteOn){ rSize -= 4; if(rSize<40) rSize=200; document.getElementById('r-circ').style.width=document.getElementById('r-circ').style.height=rSize+'px'; } 
            r.render(s, c); 
        }
        animate();
    </script>
</body>
</html>
