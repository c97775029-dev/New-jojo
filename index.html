<!DOCTYPE html>
<html>
<head>
    <title>Bizarre Legacy: Timeless Defiance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; touch-action: none; -webkit-user-select: none; }
        #menu, #charMenu, #retry { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.95); padding: 20px; border: 4px solid gold; text-align: center; color: #fff; z-index: 99; width: 320px; border-radius: 15px; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; color: #fff; display: none; pointer-events: none; }
        .bar-bg { width: 120px; height: 12px; border: 2px solid #fff; background: #333; margin: 5px auto; }
        #pBar, #eBar { width: 100%; height: 100%; transition: 0.1s; }
        #pBar { background: #00ff00; } #eBar { background: #ff0000; }
        #ctrl { position: absolute; bottom: 20px; width: 100%; text-align: center; display: none; }
        .btn-row { display: flex; justify-content: center; gap: 5px; margin-bottom: 8px; }
        button { padding: 12px; font-size: 14px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: #fff; min-width: 80px; }
        #quitBtn { position: absolute; top: 15px; right: 15px; background: #900; color: #fff; width: 80px; padding: 8px; z-index: 100; display: none; border: 2px solid white; }
        .ts-active { filter: invert(1) hue-rotate(180deg); }
        .dio-ts { filter: grayscale(1) brightness(0.7) sepia(1) hue-rotate(50deg); }
        .dmg-popup { position: absolute; color: #ff0; font-weight: bold; font-size: 22px; pointer-events: none; text-shadow: 2px 2px #000; animation: floatUp 0.8s ease-out forwards; z-index: 100; }
        #mashUI { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; z-index: 200; pointer-events: none; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.1); opacity: 0; } }
    </style>
</head>
<body id="gameBody">
    <audio id="hardMusic" loop preload="auto">
        <source src="https://vgmsite.com/soundtracks/jojo-s-bizarre-adventure-battle-tendency-ost/ndnynovn/23%20Avalon.mp3" type="audio/mpeg">
    </audio>

    <button id="quitBtn" onclick="location.reload()">QUIT</button>

    <div id="mashUI">
        <h1 id="timerTxt" style="color:red; font-size: 50px; margin:0;">3.0s</h1>
        <h2 style="color:cyan; margin: 10px 0;">TAP REPEATEDLY!</h2>
        <div class="bar-bg" style="width:240px; height:20px;"><div id="mBar" style="width:0%; background:cyan; height:100%; box-shadow: 0 0 15px cyan;"></div></div>
    </div>

    <div id="menu">
        <h2 style="color:gold">SELECT DIFFICULTY</h2>
        <button style="background:#0f0" onclick="setDiff('easy')">EASY (5s Struggle)</button>
        <button style="background:#fa0; color:#000" onclick="setDiff('med')">MEDIUM (4s Struggle)</button>
        <button style="background:#f00" onclick="setDiff('hard')">HARD (3s Struggle)</button>
        <button style="background:#555; border: 2px solid gold;" onclick="setDiff('dummy')">DUMMY</button>
    </div>

    <div id="charMenu" style="display:none">
        <h2 style="color:gold">SELECT STAND</h2>
        <button style="background:#0066ff" onclick="start('jotaro')">JOTARO</button>
        <button style="background:#228b22" onclick="start('coco')">COCO JUMBO</button>
    </div>

    <div id="ui">
        <div style="display:flex;justify-content:space-around">
            <div>YOU</div><div class="bar-bg"><div id="pBar"></div></div>
            <div>DIO</div><div class="bar-bg"><div id="eBar"></div></div>
        </div>
        <p id="msg" style="color:gold">PREPARE...</p>
    </div>

    <div id="retry" style="display:none"><h2 id="st"></h2><button onclick="location.reload()">RETRY</button></div>

    <div id="ctrl">
        <div class="btn-row">
            <button id="atkBtn" style="background:#00ff00">ATTACK</button>
            <button id="blkBtn" style="background:#555">BLOCK</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const s = new THREE.Scene(), c = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000), r = new THREE.WebGLRenderer({antialias:true});
        r.setSize(window.innerWidth, window.innerHeight); document.body.appendChild(r.domElement);
        s.add(new THREE.AmbientLight(0xffffff, 1.2)); c.position.z = 7;
        
        const p = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0x0066ff})); p.position.x = -3.5; s.add(p);
        const e = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0xff0000})); e.position.x = 4; s.add(e);
        
        let php=100, maxPHP=100, ehp=100, maxEHP=100, gOver=false, isTS=false, dioTS=false, isAdmin=false, diff='', matchActive=false;
        let eKnives = [], dioKnifePool = 0; 
        let canAttack=true, pCool=750, isBlocking=false, mashCount = 0, struggleActive = false, struggleTimer = 3.0;

        function setDiff(m) { diff=m; document.getElementById('menu').style.display='none'; document.getElementById('charMenu').style.display='block'; }

        function start(char) {
            matchActive = true; document.getElementById('quitBtn').style.display = 'block';
            if(diff === 'hard') { document.getElementById('hardMusic').play().catch(()=>{}); }
            
            if(diff === 'easy') { ehp = maxEHP = 50; }
            else if(diff === 'med') { ehp = maxEHP = 100; }
            else { ehp = maxEHP = 150; }

            if(char=='coco'){ isAdmin=true; php=1000000; maxPHP=1000000; pCool=10; p.material.color.set(0x228b22); } 
            else { isAdmin=false; php=100; maxPHP=100; pCool=750; p.material.color.set(0x0066ff); }
            
            document.getElementById('charMenu').style.display='none';
            document.getElementById('ui').style.display=document.getElementById('ctrl').style.display='block';
            upd();
            if(diff!=='dummy') runAI();
        }

        // Tap logic (Universal)
        window.addEventListener('pointerdown', () => {
            if(struggleActive) {
                mashCount++;
                document.getElementById('mBar').style.width = (mashCount * 10) + "%";
                if(mashCount >= 10) winStruggle();
            }
        });

        const blkBtn = document.getElementById('blkBtn');
        blkBtn.onpointerdown = (ev) => { ev.stopPropagation(); if(!struggleActive) { isBlocking = true; blkBtn.style.background = "cyan"; } };
        blkBtn.onpointerup = blkBtn.onpointerleave = () => { isBlocking = false; blkBtn.style.background = "#555"; };

        function winStruggle() {
            struggleActive = false; document.getElementById('mashUI').style.display = 'none';
            dioTS = false; document.body.classList.remove('dio-ts');
            // Resume all knives
            eKnives.forEach(k => k.launched = true);
            isTS = true; document.body.classList.add('ts-active');
            document.getElementById('msg').innerText = "MY TIME!";
            setTimeout(() => { isTS = false; document.body.classList.remove('ts-active'); document.getElementById('msg').innerText = "RESUMED!"; }, 3000);
        }

        function showDamage(val, x, color="#ff0") {
            const div = document.createElement('div'); div.className = 'dmg-popup';
            div.innerText = Math.floor(val); div.style.left = (window.innerWidth / 2 + (x * 80)) + 'px';
            div.style.top = '40%'; div.style.color = color; document.body.appendChild(div);
            setTimeout(() => div.remove(), 1200);
        }

        function applyHit(target, dmg, color) {
            if(target === 'p') {
                if(isBlocking) return true;
                let fDmg = (diff === 'easy') ? dmg * 0.5 : (diff === 'hard' ? dmg * 1.3 : dmg);
                php -= fDmg; showDamage(fDmg, p.position.x, color);
            } else { ehp -= dmg; showDamage(dmg, e.position.x, color); }
            upd(); return false;
        }

        document.getElementById('atkBtn').onclick = (ev) => {
            ev.stopPropagation();
            if(gOver || (!canAttack && !isTS) || dioTS || isBlocking) return;
            if(!isTS) canAttack = false; 
            applyHit('e', isTS ? 0.5 : (isAdmin?1000:5), isTS?"#0ff":"#ff0");
            if(!isTS) setTimeout(() => { canAttack=true; }, pCool);
        };

        async function runAI() {
            while(matchActive && !gOver) {
                await new Promise(r => setTimeout(r, 1300));
                if(isTS || dioTS) continue;
                let tsChance = (diff==='easy') ? 0.05 : (diff==='med' ? 0.15 : 0.35);
                if(Math.random() < tsChance) {
                    dioTS = true; struggleActive = true; 
                    struggleTimer = (diff==='easy') ? 5.0 : (diff==='med' ? 4.0 : 3.0);
                    mashCount = 0;
                    document.body.classList.add('dio-ts');
                    document.getElementById('mashUI').style.display = 'block';
                    document.getElementById('mBar').style.width = "0%";
                    let knfCount = (diff==='easy') ? 4 : (diff==='med' ? 7 : 14);
                    for(let i=0; i<knfCount; i++) setTimeout(() => { if(dioTS) spawnEKnife(false); }, i * 150);
                } else if (Math.random() < 0.6) { spawnEKnife(true); } 
                else { e.position.x = -2.5; applyHit('p', 8, "#f00"); setTimeout(()=>e.position.x = 4, 150); }
            }
        }

        function spawnEKnife(autoLaunch) {
            const knf = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.15, 0.1), new THREE.MeshStandardMaterial({color: 0xffaa00}));
            knf.position.set(e.position.x - 0.5, e.position.y + (Math.random()*1.5-0.75), 0);
            s.add(knf); eKnives.push({ mesh: knf, launched: autoLaunch, reflected: false });
        }

        function upd() {
            document.getElementById('eBar').style.width = (diff==='dummy') ? '100%' : (ehp/maxEHP*100)+'%';
            document.getElementById('pBar').style.width=(php/maxPHP*100)+'%';
            if(php<=0 || (ehp<=0 && diff!=='dummy')) { 
                gOver=true; document.getElementById('retry').style.display='block'; 
                document.getElementById('st').innerText=php<=0?"RETIRED":"DIO DEFEATED"; 
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(struggleActive) {
                struggleTimer -= 0.016;
                document.getElementById('timerTxt').innerText = Math.max(0, struggleTimer).toFixed(1) + "s";
                if(struggleTimer <= 0) { 
                    dioTS = false; struggleActive = false; 
                    document.body.classList.remove('dio-ts'); 
                    document.getElementById('mashUI').style.display = 'none';
                    eKnives.forEach(k => k.launched = true);
                }
            }
            if(matchActive && !gOver) {
                eKnives.forEach((k, i) => {
                    if (k.launched) {
                        let kSpeed = (diff==='easy') ? 0.12 : (diff==='med' ? 0.25 : 0.42);
                        k.mesh.position.x += k.reflected ? 0.6 : -kSpeed;
                        if (!k.reflected && Math.abs(k.mesh.position.x - p.position.x) < 0.6) {
                            if(isBlocking) { k.reflected = true; k.mesh.material.color.set(0x00ffff); }
                            else { applyHit('p', 12, "#f00"); s.remove(k.mesh); eKnives.splice(i, 1); }
                        } else if (k.reflected && Math.abs(k.mesh.position.x - e.position.x) < 0.6) { applyHit('e', 20, "cyan"); s.remove(k.mesh); eKnives.splice(i, 1); }
                        else if(Math.abs(k.mesh.position.x) > 15) { s.remove(k.mesh); eKnives.splice(i, 1); }
                    }
                });
            }
            r.render(s, c);
        }
        animate();
    </script>
</body>
</html>
